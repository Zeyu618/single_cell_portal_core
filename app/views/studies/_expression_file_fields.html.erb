<div class="form-group row">
  <div class="col-sm-12">
    <%= f.label :y_axis_label, 'Expression Axis Label' %>&nbsp;<span class="fas fa-question-circle" data-toggle="tooltip" data-placement="right" title="This is displayed as the axis label for box & scatter plots showing expression values.  This label is global to all expression values.<%= @study.has_expression_label? ? ' Please use the study default options form to update this value.' : '' %>"></span> <br />
    <%= f.text_field :y_axis_label, value: @study.has_expression_label? ? @study.default_expression_label : f.object.y_axis_label, placeholder: @study.default_expression_label, class: 'form-control', disabled: @study.has_expression_label? %>
  </div>
</div>
<div class="form-group">
  <%= f.fields_for :expression_file_info do |expr_file_info|
    render partial: 'expression_file_info_fields',
           locals: {
             disable_processed: false,
             disable_raw_counts: false,
             f: expr_file_info
           }
  end %>
</div>

<script type="text/javascript" nonce="<%= content_security_policy_script_nonce %>">
  function updateRawCountsAssnSelect() {
    const formId = '#study-file-<%= f.object.id.to_s %>'
    const rawAssnTarget = $(`${formId} .raw_associations_select`)[0]
    const pairedHiddenField = $(`${formId} .raw_counts_associations`)[0]
    <% current_values = f.object.associated_matrix_files(:raw)&.map { |sf| { label: sf.name, value: sf.id.to_s } } %>
    const currentValues = <%= current_values.to_json.html_safe %>
    const opts = window.SCP.currentStudyFiles.filter(sf => sf?.expression_file_info?.is_raw_counts)
      ?.map(sf => ({ label: sf.upload_file_name, value: sf['_id']['$oid'] }))
    window.SCP.renderRawAssociationSelect(rawAssnTarget, currentValues, pairedHiddenField, opts)
  }

  updateRawCountsAssnSelect()

  $(window).on('updateRawCountsSelect', function() {
    updateRawCountsAssnSelect()
  })

  $('form').on('change', '.is_raw_counts_true, .is_raw_counts_false', function() {
    updateRawCountsAssnSelect()
  })
</script>
